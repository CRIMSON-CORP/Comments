<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link rel="stylesheet" href="./bootstrap/dist/css/bootstrap.min.css" />
        <title>Admin</title>
        <style>
            body {
                background-color: rgb(247, 247, 247);
            }
            .container .jumbotron {
                border-radius: 16px;
                background-color: white;
            }
            .avatar {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background-color: rgb(240, 240, 240);
            }
            .comment-header {
                gap: 20px;
            }
            .lead {
                font-weight: 700;
                display: flex;
                gap: 10px;
            }
            .dot {
                width: 5px;
                height: 5px;
                border-radius: 50%;
                background-color: black;
            }
        </style>
    </head>
    <body>
        <div class="container mt-5">
            <div class="alert-box"></div>
            <div class="row">
                <h1 class="display-3">Pending Comments!</h1>
                <section class="p-3" id="comments-wrapper"></section>
            </div>
            <div class="row">
                <h1 class="display-3">Approved Comments!</h1>
                <section class="p-3" id="approved-comments-wrapper"></section>
            </div>
        </div>

        <script>
            window.addEventListener("load", async () => {
                await fetchAllComments();
            });

            async function fetchAllComments() {
                await getAllComments();
                await getAllApprovedComments();
            }
            const comments_wrapper = document.querySelector("#comments-wrapper");
            const approved_comments_wrapper = document.querySelector("#approved-comments-wrapper");
            const alertBox = document.querySelector(".alert-box");
            async function getAllComments() {
                try {
                    comments_wrapper.innerHTML = " <h3>Loading</h3>";
                    let result = await fetch("http://localhost:4000/comments");
                    let { data } = await result.json();
                    LoadCommentsToDOM(data);
                } catch (error) {
                    comments_wrapper.innerHTML =
                        "<h3 class='text-danger'>Error loading Comments</h3>";
                }
            }

            async function getAllApprovedComments() {
                try {
                    approved_comments_wrapper.innerHTML = " <h3>Loading</h3>";
                    let result = await fetch("http://localhost:4000/approved_comments");
                    let { data } = await result.json();
                    LoadApprovedCommentsToDOM(data);
                } catch (error) {
                    approved_comments_wrapper.innerHTML =
                        "<h3 class='text-danger'>Error loading Comments</h3>";
                }
            }

            function LoadCommentsToDOM(comments) {
                let comments_storage = [];
                comments.forEach((element) => {
                    comments_storage.push(
                        `<div class="jumbotron p-3 mb-4 shadow-md">
                        <div class="comment-header d-flex flex-direction-row align-items-center">
                            <div class="avatar justify-content-center align-items-center">
                                <span class="glyphicon glyphicon-user"></span>
                            </div>
                            <p class="lead p-0 m-0 d-flex  align-items-center">
                                ${element.name}<span class="dot"></span>
                                <span class="text-muted">${element.date}</span>
                            </p>
                        </div>
                        <p class="pt-2">
                            ${element.comment}
                        </p>
                        <p class="lead">
                            <button class="btn btn-success btn-lg" onclick="approveComment('${element.id}','${element.name}' ,this)" role="button"><span>Approve</span></button>
                            <button class="btn btn-danger btn-lg" onclick="deleteComment('${element.id}','${element.name}',  this)" role="button"><span>Delete</span></button>
                        </p>
                    </div>`
                    );
                });
                if (comments_storage.length === 0)
                    comments_wrapper.innerHTML = " <h3>No Comments!</h3>";
                else comments_wrapper.innerHTML = comments_storage.join("");
            }

            function LoadApprovedCommentsToDOM(comments) {
                let comments_storage = [];
                comments.forEach((element) => {
                    comments_storage.push(
                        `<div class="jumbotron p-3 mb-4 shadow-md">
                        <div class="comment-header d-flex flex-direction-row align-items-center">
                            <div class="avatar justify-content-center align-items-center">
                                <span class="glyphicon glyphicon-user"></span>
                            </div>
                            <p class="lead p-0 m-0 d-flex  align-items-center">
                                ${element.name}<span class="dot"></span>
                                <span class="text-muted">${element.date}</span>
                            </p>
                        </div>
                        <p class="pt-2">
                            ${element.comment}
                        </p>
                        <p class="lead">
                            <button class="btn btn-primary btn-lg" onclick="unapproveComment('${element.id}','${element.name}',  this)" role="button"><span>Unapprove</span></button>
                            <button class="btn btn-danger btn-lg" onclick="deleteComment('${element.id}','${element.name}',  this)" role="button"><span>Delete</span></button>
                        </p>
                    </div>`
                    );
                });
                if (comments_storage.length === 0)
                    approved_comments_wrapper.innerHTML = " <h3>No Comments!</h3>";
                else approved_comments_wrapper.innerHTML = comments_storage.join("");
            }

            async function approveComment(commentors_id, commentors_name, parent) {
                const span = parent.querySelector("span");
                span.className = "spinner-border spinner-border-sm";
                span.innerHTML = null;
                try {
                    let result = await fetch("http://localhost:4000/approve_comment", {
                        headers: {
                            "content-type": "application/json",
                            accept: "*/*",
                        },
                        method: "POST",
                        body: JSON.stringify({ id: commentors_id }),
                    });
                    let data = await result.json();
                    if (data.success) {
                        alertBox.innerHTML = `<div class="alert alert-success" role="alert">
                            <strong>You Approved ${commentors_name}'s Comment!</strong>
                        </div>`;
                    }
                    return await fetchAllComments();
                } catch (error) {
                    alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                            <strong>Error Approving Comment!</strong>
                        </div>`;
                } finally {
                    span.className = "";
                    span.innerHTML = "Approve";
                    setTimeout(() => (alertBox.innerHTML = null), 3000);
                }
            }
            async function deleteComment(commentors_id, commentors_name, parent) {
                const span = parent.querySelector("span");
                span.className = "spinner-border spinner-border-sm";
                span.innerHTML = null;
                try {
                    let result = await fetch("http://localhost:4000/delete_comment", {
                        headers: {
                            "content-type": "application/json",
                            accept: "*/*",
                        },
                        method: "DELETE",
                        body: JSON.stringify({ id: commentors_id }),
                    });
                    let data = await result.json();
                    if (data.success) {
                        alertBox.innerHTML = `<div class="alert alert-success" role="alert">
                            <strong>You Deleted ${commentors_name}'s Comment!</strong>
                        </div>`;
                    }
                    return await fetchAllComments();
                } catch (error) {
                    alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                            <strong>Error Deleting Comment!</strong>
                        </div>`;
                } finally {
                    span.className = "";
                    span.innerHTML = "Delete";
                    setTimeout(() => (alertBox.innerHTML = null), 3000);
                }
            }
            async function unapproveComment(commentors_id, commentors_name, parent) {
                const span = parent.querySelector("span");
                span.className = "spinner-border spinner-border-sm";
                span.innerHTML = null;
                try {
                    let result = await fetch("http://localhost:4000/unapprove_comment", {
                        headers: {
                            "content-type": "application/json",
                            accept: "*/*",
                        },
                        method: "POST",
                        body: JSON.stringify({ id: commentors_id }),
                    });
                    let data = await result.json();
                    if (data.success) {
                        alertBox.innerHTML = `<div class="alert alert-success" role="alert">
                            <strong>You Unapproved ${commentors_name}'s Comment!</strong>
                        </div>`;
                    }
                    return await fetchAllComments();
                } catch (error) {
                    alertBox.innerHTML = `<div class="alert alert-danger" role="alert">
                            <strong>Error Unapproving Comment!</strong>
                        </div>`;
                } finally {
                    span.className = "";
                    span.innerHTML = "Unapprove";
                    setTimeout(() => (alertBox.innerHTML = null), 3000);
                }
            }
        </script>
    </body>
</html>
